<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>VanGo</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="control.html"><strong aria-hidden="true">2.</strong> Control</a></li><li class="chapter-item expanded "><a href="comms.html"><strong aria-hidden="true">3.</strong> Communications</a></li><li class="chapter-item expanded "><a href="dev.html"><strong aria-hidden="true">4.</strong> Development</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">VanGo</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>VanGo is a differential drive robot for drawing SVG images. Put simply,
VanGo is a wheeled mobile robot capable of trajectory tracking,
with the added feature that the trajectory is generated from an SVG
image and the robot holds a marker which is brought into contact with the
page while the robot is on the desired path, thus drawing the SVG image.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="control"><a class="header" href="#control">Control</a></h1>
<p>VanGo's control architecture is comprised of a lower level speed control loop
and a higher level trajectory tracking controller. From a user perspective, the lower level
control loop can mostly be ignored, or at least treated as a black box and not modified, while the
higher level controller may leave more room for customization.</p>
<h2 id="low-level-speed-controller"><a class="header" href="#low-level-speed-controller">Low-Level Speed Controller</a></h2>
<p>Running on the ESP32 microcontroller, a timer based interrupt is resposible for reading the
quadrature wheel encoders to compute the speed of the wheels. Experimentally it was determined that
a simply proportional controller was sufficient for closed-loop speed control, although Proportional-Derivative (PD)
control was also tested. Although PD control results is a smoother trajectory with less overshoot, the slower response
was not worth the minimization of overshoot. Either way, both P and PD controllers work fairly well for closed-loop
speed control, and if one is preferred by the user, the gains may be adjusted in the firmware and reflashed to the board.
For more information on editing and flashing firmware, see <a href="./dev.html">Development</a>.</p>
<p>The two images below show the speed controller response for both the Proportional and Proportional-Derivative controllers.</p>
<p><img src="./images/p_speed_control.png" alt="Proportional control" /></p>
<p><img src="./images/pd_speed_control.png" alt="Proportional-Derivative control" /></p>
<h2 id="high-level-trajectory-controller"><a class="header" href="#high-level-trajectory-controller">High-Level Trajectory Controller</a></h2>
<p>The <code>vango-client</code> implements a trajectory tracking algorithm which is used to follow a trajectory defined
by a set of waypoints.</p>
<p>There are many different trajectory tracking algorithms in existance, however at this time only one,and perhaps the most basic one,the PID controller, has been implemented for the VanGo robot. There are various ways a PID controller can be applied to the trajectory tracking problem, however the method I've chosen to implement is to use a PID controller for angular velocity control. To move the robot from its current (x, y) to some goal position which is presumably along the target path, the algorithm works as follows:</p>
<ol>
<li>Read the current pose (computed from wheel odometry) via BLE</li>
<li>Compute the target angle as \(atan2(y_{goal} - y, x_{goal} - x)\)</li>
<li>Let the error be the minimum angle between the robots current heading and the target heading</li>
<li>Compute the control signal from the PID controller for the given error. This control signal is chosen to represent the angular velocity of the robot.</li>
<li>The desired motion of the robot is then represented as a 2D twist (body velocity), using the computed target angular velocity, a constant x velocity of your choice, and a y velocity of 0.0 (which assumes no wheel slipping)</li>
<li>Compute the left and right wheel speeds needed to achieve the target twist</li>
</ol>
<p>During development, there was a choice to be made regarding whether the trajectory controller
will operate at the client application level or the firmware level. Both options have positives and negatives and will be briefly discussed below. In the end, it was chosen to operate the trajectory controller at the client application level.</p>
<h3 id="client-side-trajectory-controller"><a class="header" href="#client-side-trajectory-controller">Client-Side Trajectory Controller</a></h3>
<p>A client side trajectory controller works by implementing the trajectory tracking algorithm in the <code>vango-client</code>
application. The controller will obtain the robots current pose using bluetooth low-energy (BLE) and compute the necessary wheel speeds for tracking the desired trajectory, and send those target wheel
speeds back to the robot over BLE.</p>
<p><strong>Pros</strong></p>
<ul>
<li>Faster development time since you will not need to reflash the microcontroller</li>
<li>Easier to test different trajectory tracking algorithms or enable several algorithms to be available as options to the user</li>
<li>Can take advantage of a client machine with higher computing power than the microcontroller</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>Control loop speed is limited by BLE read/write latency. In it's current state, loop speeds top out around 30Hz.</li>
</ul>
<h3 id="firmware-side-trajectory-controller"><a class="header" href="#firmware-side-trajectory-controller">Firmware-Side Trajectory Controller</a></h3>
<p>An alternative way to implement the trajectory tracking controller would be to implement the controller in the firmware on the microcontroller, obtaining the target path to follow from the client over BLE. Pros and Cons are listed below.</p>
<p><strong>Pros</strong></p>
<ul>
<li>The MCU is capable of more precise and consistant timing through the use of hardware timers and interrupts</li>
<li>BLE communication latency is no longer a concern since waypoints could be sent and processed beforehand</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>Resources are somewhat limited on the MCU and may impose practical limits of which algorithms can be employed</li>
<li>Slower development time since for the most part, modifications to the trajectory tacking algorithm require reflashing the board</li>
</ul>
<p>Although performance/timing of the control loop could potentially be better if implemented in the MCU, it was determined that easy customization of algorithms as well as development time are key aspects of the project, therefore a client-side trajectory tracking algorithm was employed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="communications"><a class="header" href="#communications">Communications</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development"><a class="header" href="#development">Development</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
